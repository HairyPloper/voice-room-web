<!doctype html>
<html lang="sr">
  <head>
    <meta charset="UTF-8" />
    <meta
      name="viewport"
      content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no"
    />
    <title>Linkice</title>
    <link
      href="https://fonts.googleapis.com/css2?family=Outfit:wght@300;500;700&display=swap"
      rel="stylesheet"
    />
    <link
      rel="icon"
      href="data:image/svg+xml,<svg xmlns=%22http://www.w3.org/2000/svg%22 viewBox=%220 0 100 100%22><text y=%22.9em%22 font-size=%2290%22>ðŸ”—</text></svg>"
    />
    <script src="https://download.agora.io/sdk/release/AgoraRTC_N-4.11.0.js"></script>
    <style>
      :root {
        --primary: #6366f1;
        --secondary: #a855f7;
        --accent: #ec4899;
        --glass-bg: rgba(15, 23, 42, 0.6);
        --glass-border: rgba(255, 255, 255, 0.08);
        --success: #10b981;
        --danger: #ef4444;
      }

      body {
        font-family: "Outfit", sans-serif;
        background: #0f172a;
        color: white;
        margin: 0;
        display: flex;
        flex-direction: column;
        align-items: center;
        height: 100vh;
        overflow: hidden;
      }

      /* --- VIDEO BACKGROUND --- */
      .video-background {
        position: fixed;
        top: 0;
        left: 0;
        width: 100vw;
        height: 100vh;
        z-index: -2;
        overflow: hidden;
      }
      .video-background video {
        position: absolute;
        top: 50%;
        left: 50%;
        transform: translate(-50%, -50%);
        min-width: 100%;
        min-height: 100%;
        width: auto;
        height: auto;
        object-fit: cover;
      }
      .video-overlay {
        position: absolute;
        top: 0;
        left: 0;
        width: 100%;
        height: 100%;
        background: rgba(3, 7, 18, 0.5); /* Darker tint for contrast */
        backdrop-filter: blur(2px);
        z-index: -1;
      }

      /* --- MOBILE OVERRIDES --- */
      @media (max-width: 767px) {
        .video-background {
          display: none !important;
        }
        body {
          /* Deep rich gradient for mobile */
          background: radial-gradient(
            circle at center,
            #2e1065,
            #020617 80%
          ) !important;
        }
      }

      /* --- HEADER --- */
      .header {
        margin-top: 20px;
        padding: 15px 30px;
        min-width: 250px;
        text-align: center;
        background: var(--glass-bg);
        backdrop-filter: blur(12px);
        -webkit-backdrop-filter: blur(12px);
        border: 1px solid var(--glass-border);
        border-radius: 50px;
        box-shadow: 0 4px 30px rgba(0, 0, 0, 0.1);
        z-index: 10;
        animation: slideDown 0.6s cubic-bezier(0.2, 0.8, 0.2, 1);
      }

      h2 {
        margin: 0;
        font-size: 1.8rem;
        font-weight: 700;
        background: linear-gradient(135deg, #a5b4fc, #f0abfc);
        -webkit-background-clip: text;
        -webkit-text-fill-color: transparent;
        letter-spacing: -0.5px;
        text-shadow: 0 0 20px rgba(168, 85, 247, 0.3);
      }

      /* --- GRID --- */
      #user-grid {
        display: flex;
        flex-wrap: wrap;
        justify-content: center;
        gap: 20px;
        width: 100%;
        max-width: 800px;
        padding: 40px 20px;
        flex-grow: 1;
        overflow-y: auto;
        align-content: center; /* Center vertically */
      }
      .btn:disabled {
        cursor: not-allowed;
        filter: grayscale(0.5);
      }

      /* --- USER CARDS --- */
      .user-card {
        display: flex;
        flex-direction: column;
        align-items: center;
        background: rgba(255, 255, 255, 0.03);
        border: 1px solid rgba(255, 255, 255, 0.05);
        border-radius: 24px;
        padding: 15px;
        width: 100px;
        transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
        cursor: pointer;
        position: relative;
        overflow: hidden;
      }

      .user-card:hover {
        background: rgba(255, 255, 255, 0.08);
        transform: translateY(-5px);
        box-shadow: 0 10px 30px -10px rgba(0, 0, 0, 0.5);
        border-color: rgba(255, 255, 255, 0.2);
      }

      .user-card:active {
        transform: scale(0.95);
      }

      .avatar-container {
        position: relative;
      }

      .avatar {
        width: 70px;
        height: 70px;
        border-radius: 20px;
        background: linear-gradient(
          135deg,
          rgba(255, 255, 255, 0.1),
          rgba(255, 255, 255, 0.05)
        );
        display: flex;
        align-items: center;
        justify-content: center;
        font-size: 32px;
        box-shadow: inset 0 0 20px rgba(255, 255, 255, 0.02);
        transition: 0.3s;
        border: 1px solid rgba(255, 255, 255, 0.1);
      }

      .avatar.muted {
        opacity: 0.5;
        filter: grayscale(1);
        box-shadow: none;
      }

      .username {
        margin-top: 10px;
        font-size: 0.85rem;
        font-weight: 500;
        color: #e2e8f0;
        text-shadow: 0 2px 4px rgba(0, 0, 0, 0.5);
      }

      /* --- CONTROLS --- */
      .controls {
        width: auto;
        margin-bottom: 50px;
        padding: 10px;
        display: flex;
        justify-content: center;
        background: rgba(0, 0, 0, 0.3); /* Transparent pill */
        backdrop-filter: blur(10px);
        border-radius: 60px;
        border: 1px solid rgba(255, 255, 255, 0.1);
        box-shadow: 0 20px 40px rgba(0, 0, 0, 0.4);
      }

      .btn {
        padding: 14px 32px;
        border-radius: 50px;
        border: none;
        font-family: "Outfit", sans-serif;
        font-size: 16px;
        font-weight: 600;
        cursor: pointer;
        color: white;
        transition: 0.3s;
        box-shadow: 0 4px 15px rgba(0, 0, 0, 0.2);
        display: flex;
        align-items: center;
        gap: 8px;
      }

      .join-btn {
        background: linear-gradient(135deg, #6366f1, #8b5cf6);
        box-shadow: 0 0 20px rgba(99, 102, 241, 0.4);
      }
      .join-btn:hover {
        transform: scale(1.05);
        box-shadow: 0 0 30px rgba(99, 102, 241, 0.6);
      }

      .leave-btn {
        background: rgba(255, 255, 255, 0.1);
        border: 1px solid rgba(239, 68, 68, 0.3);
        color: #fca5a5;
        display: none;
      }
      .leave-btn:hover {
        background: rgba(239, 68, 68, 0.2);
        color: white;
      }

      /* --- ANIMATIONS & INDICATORS --- */
      @keyframes neonPulse {
        0% {
          box-shadow: 0 0 0 0 rgba(16, 185, 129, 0.7);
          border-color: #10b981;
        }
        70% {
          box-shadow: 0 0 0 15px rgba(16, 185, 129, 0);
          border-color: #10b981;
        }
        100% {
          box-shadow: 0 0 0 0 rgba(16, 185, 129, 0);
          border-color: rgba(255, 255, 255, 0.1);
        }
      }

      .speaking {
        animation: neonPulse 1.5s infinite;
        transform: scale(1.05);
        background: rgba(16, 185, 129, 0.1);
      }

      @keyframes slideDown {
        from {
          transform: translateY(-50px);
          opacity: 0;
        }
        to {
          transform: translateY(0);
          opacity: 1;
        }
      }

      /* Volume slider styles */
      .volume-controls {
        height: 0;
        overflow: hidden;
        transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
        width: 100%;
        display: flex;
        flex-direction: column;
        align-items: center;
        opacity: 0;
      }
      .user-card.active .volume-controls {
        height: 30px;
        margin-top: 8px;
        opacity: 1;
      }

      .volume-slider {
        width: 80%;
        height: 4px;
        border-radius: 2px;
        background: rgba(255, 255, 255, 0.2);
        outline: none;
        -webkit-appearance: none;
      }
      .volume-slider::-webkit-slider-thumb {
        -webkit-appearance: none;
        appearance: none;
        width: 12px;
        height: 12px;
        background: white;
        border-radius: 50%;
        cursor: pointer;
        box-shadow: 0 0 10px white;
      }
    </style>
  </head>
  <body>
    <div class="video-background">
      <div class="video-overlay"></div>
      <video loop muted playsinline preload="auto">
        <source
          src="https://us-west-2-epicgames.graphassets.com/cmkr1i7c9047e07n0es5291ez/cmis28lk91sq907mv9aydajlk"
          type="video/mp4"
        />
      </video>
    </div>

    <div class="header">
      <h2>LINKICE ðŸ”—</h2>
      <div
        id="status"
        style="
          margin-top: 5px;
          font-size: 0.8rem;
          color: #cbd5e1;
          font-weight: 300;
        "
      >
        Spremno
      </div>
    </div>

    <div id="user-grid"></div>

    <div class="controls">
      <button id="join-btn" class="btn join-btn"><span>ðŸš€</span> Upadni</button>
      <button id="leave-btn" class="btn leave-btn">
        <span>ðŸ‘‹</span> Ä†aoo drugaryy
      </button>
    </div>

    <script>
      const APP_ID = "beb2d2e844954540847d8bf07648926e";
      const CHANNEL = "Linkice";
      const params = new URLSearchParams(window.location.search);
      const myUsername = params.get("name") || "Gost";

      const animals = [
        "ðŸ¦",
        "ðŸ¦Š",
        "ðŸ¨",
        "ðŸ˜",
        "ðŸ¯",
        "ðŸ¼",
        "ðŸ™",
        "ðŸ¦‰",
        "ðŸ¸",
        "ðŸ¦“",
        "ðŸ¦„",
        "ðŸ",
      ];
      const myIcon = animals[Math.floor(Math.random() * animals.length)];

      let client = AgoraRTC.createClient({ mode: "rtc", codec: "vp8" });
      let localTracks = { audioTrack: null };
      let isMuted = false;
      let wakeLock = null;

      async function requestWakeLock() {
        try {
          if ("wakeLock" in navigator)
            wakeLock = await navigator.wakeLock.request("screen");
        } catch (err) {}
      }

      function sanitizeForAgora(name) {
        const map = {
          Å¡: "sh",
          Å : "Sh",
          Ä‡: "ch",
          Ä†: "Ch",
          Ä: "ch",
          ÄŒ: "Ch",
          Å¾: "zh",
          Å½: "Zh",
          Ä‘: "dj",
          Ä: "Dj",
        };
        return name
          .replace(/[Å¡Ä‡ÄÅ¾Ä‘]/gi, (m) => map[m] || map[m.toLowerCase()])
          .replace(/\s+/g, "")
          .replace(/[^a-zA-Z0-9!#$%&()+-:;<=.>?@[\]^_{|}~,]/g, "");
      }

      function getUniqueUsername(baseName) {
        return `${baseName}_${Math.floor(1000 + Math.random() * 9000)}`;
      }
      function getDisplayName(uid) {
        return typeof uid === "string" && uid.includes("_")
          ? uid.substring(0, uid.lastIndexOf("_"))
          : String(uid);
      }

      function drawUser(uid, username, icon, isMe = false) {
        if (document.getElementById(`user-${uid}`)) return;
        const randomIcon =
          icon || animals[Math.floor(Math.random() * animals.length)];
        const grid = document.getElementById("user-grid");
        const card = document.createElement("div");
        card.id = `user-${uid}`;
        card.className = "user-card";
        // Click to toggle mute (self) or show volume (others)
        card.onclick = isMe
          ? () => window.toggleMute()
          : (e) => {
              document.querySelectorAll(".user-card.active").forEach((c) => {
                if (c !== card) c.classList.remove("active");
              });
              card.classList.toggle("active");
            };

        card.innerHTML = `
          <div class="avatar-container"><div class="avatar" id="avatar-${uid}">${randomIcon}</div></div>
          <div class="username">${username}${isMe ? " (Ti)" : ""}</div>
          ${
            !isMe
              ? `<div class="volume-controls" onclick="event.stopPropagation()">
            <input type="range" class="volume-slider" min="0" max="100" value="100" oninput="window.adjustVolume('${uid}', this.value)">
          </div>`
              : ""
          }
        `;
        grid.appendChild(card);
      }

      client.on("user-published", async (user, mediaType) => {
        await client.subscribe(user, mediaType);
        if (mediaType === "audio") {
          drawUser(user.uid, getDisplayName(user.uid));
          user.audioTrack.play();
          document
            .getElementById(`avatar-${user.uid}`)
            ?.classList.remove("muted");
        }
      });

      client.on("user-unpublished", (user, mediaType) => {
        if (mediaType === "audio")
          document.getElementById(`avatar-${user.uid}`)?.classList.add("muted");
      });

      client.on("user-left", (user) =>
        document.getElementById(`user-${user.uid}`)?.remove(),
      );
      client.on("user-joined", (user) =>
        drawUser(user.uid, getDisplayName(user.uid)),
      );

      client.enableAudioVolumeIndicator();
      client.on("volume-indicator", (volumes) => {
        document
          .querySelectorAll(".avatar.speaking")
          .forEach((av) => av.classList.remove("speaking"));
        volumes.forEach((vol) => {
          const id = vol.uid === 0 ? client.uid : vol.uid;
          if (vol.level > 5)
            document.getElementById(`avatar-${id}`)?.classList.add("speaking");
        });
      });

      document.getElementById("join-btn").onclick = async () => {
        const joinBtn = document.getElementById("join-btn");

        // 1. Prevent double clicks
        if (joinBtn.disabled) return;
        joinBtn.disabled = true;
        joinBtn.style.opacity = "0.5";
        joinBtn.innerText = "Povezivanje...";

        const bgVideo = document.querySelector(".video-background video");
        if (bgVideo && window.innerWidth >= 768) bgVideo.play().catch(() => {});

        try {
          const uniqueName = getUniqueUsername(sanitizeForAgora(myUsername));

          // 2. Join the channel
          await client.join(APP_ID, CHANNEL, null, uniqueName);

          client.remoteUsers.forEach((user) =>
            drawUser(user.uid, getDisplayName(user.uid)),
          );

          localTracks.audioTrack = await AgoraRTC.createMicrophoneAudioTrack();
          await client.publish(localTracks.audioTrack);

          drawUser(client.uid, getDisplayName(uniqueName), myIcon, true);
          await requestWakeLock();

          // 3. Success state
          joinBtn.style.display = "none";
          document.getElementById("leave-btn").style.display = "flex";
          const s = document.getElementById("status");
          s.innerText = "Povezan â€¢ Live";
          s.style.color = "#4ade80";
        } catch (e) {
          console.error(e);
          alert("GreÅ¡ka pri spajanju. Proverite dozvolu za mikrofon.");

          // 4. Reset button if it fails so they can try again
          joinBtn.disabled = false;
          joinBtn.style.opacity = "1";
          joinBtn.innerHTML = "<span>ðŸš€</span> Upadni";
        }
      };

      document.getElementById("leave-btn").onclick = async () => {
        if (wakeLock) await wakeLock.release();
        if (localTracks.audioTrack) {
          localTracks.audioTrack.stop();
          localTracks.audioTrack.close();
        }
        await client.leave();
        location.reload();
      };

      window.adjustVolume = (uid, vol) => {
        const u = client.remoteUsers.find((u) => u.uid == uid);
        if (u?.audioTrack) u.audioTrack.setVolume(parseInt(vol));
      };

      window.toggleMute = async () => {
        if (!localTracks.audioTrack) return;
        isMuted = !isMuted;
        await localTracks.audioTrack.setEnabled(!isMuted);
        document
          .getElementById(`avatar-${client.uid}`)
          ?.classList.toggle("muted", isMuted);
        const s = document.getElementById("status");
        s.innerText = isMuted ? "Mutiran ðŸ¤" : "Povezan â€¢ Live";
        s.style.color = isMuted ? "#f87171" : "#4ade80";
      };

      // --- PARTICLES ---
      (function () {
        const canvas = document.createElement("canvas");
        Object.assign(canvas.style, {
          position: "fixed",
          top: "0",
          left: "0",
          width: "100vw",
          height: "100vh",
          pointerEvents: "none",
          zIndex: "-1",
        });
        document.body.appendChild(canvas);
        const ctx = canvas.getContext("2d");
        let particles = [];
        const isPako = myUsername === "Pako";
        const symbols = ["â¤", "ðŸ’–", "ðŸ’•", "ðŸ’—", "ðŸ’“"];

        function resize() {
          canvas.width = window.innerWidth;
          canvas.height = window.innerHeight;
          particles = Array.from({ length: isPako ? 100 : 150 }, () => ({
            x: Math.random() * canvas.width,
            y: Math.random() * canvas.height,
            speed: 0.4 + Math.random() * 0.8,
            drift: (Math.random() - 0.5) * 0.3,
            size: isPako ? 10 + Math.random() * 15 : 2 + Math.random() * 3,
            opacity: 0.3 + Math.random() * 0.5,
            symbol: symbols[Math.floor(Math.random() * symbols.length)],
          }));
        }
        window.addEventListener("resize", resize);
        resize();

        function draw() {
          ctx.clearRect(0, 0, canvas.width, canvas.height);
          particles.forEach((p) => {
            ctx.globalAlpha = p.opacity;
            if (isPako) {
              ctx.font = `${p.size}px serif`;
              ctx.fillText(p.symbol, p.x, p.y);
            } else {
              ctx.fillStyle = "white";
              ctx.beginPath();
              ctx.arc(p.x, p.y, p.size, 0, Math.PI * 2);
              ctx.fill();
            }
            p.y += p.speed;
            p.x += p.drift;
            if (p.y > canvas.height + 20) {
              p.y = -20;
              p.x = Math.random() * canvas.width;
            }
          });
          requestAnimationFrame(draw);
        }
        draw();
      })();
    </script>
  </body>
</html>
